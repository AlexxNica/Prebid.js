<script type="text/javascript">
// https://tc39.github.io/ecma262/#sec-array.prototype.find
if (!Array.prototype.find) {
  Object.defineProperty(Array.prototype, 'find', {
    value: function(predicate) {
      if (this == null) {
        throw new TypeError('"this" is null or not defined');
      }
      var o = Object(this);
      var len = o.length >>> 0;
      if (typeof predicate !== 'function') {
        throw new TypeError('predicate must be a function');
      }
      var thisArg = arguments[1];
      var k = 0;
      while (k < len) {
        var kValue = o[k];
        if (predicate.call(thisArg, kValue, k, o)) {
          return kValue;
        }
        k++;
      }
      return undefined;
    }
  });
}

//http://stackoverflow.com/questions/2907482/how-to-get-the-query-string-by-javascript
function getQueryStrings() {
  var assoc  = {};
  var decode = function (s) { return decodeURIComponent(s.replace(/\+/g, " ")); };
  var queryString = location.search.substring(1);
  var keyValues = queryString.split('&');

  for(var i in keyValues) {
    var key = keyValues[i].split('=');
    if (key.length > 1) {
      assoc[decode(key[0])] = decode(key[1]);
    }
  }

  return assoc;
}

var qs = getQueryStrings();
var conf = JSON.parse(qs['conf']);

var pbjs = pbjs || {};
pbjs.que = pbjs.que || [];

(function() {
    var pbjsEl = document.createElement("script"); pbjsEl.type = "text/javascript";
    pbjsEl.async = true; var isHttps = 'https:' === document.location.protocol;
    pbjsEl.src = (isHttps ? "https" : "http") + "://acdn.adnxs.com/prebid/not-for-prod/prebid.js";
    var pbjsTargetEl = document.getElementsByTagName("head")[0];
    pbjsTargetEl.insertBefore(pbjsEl, pbjsTargetEl.firstChild);
})();

pbjs.que.push(function() {
    var adUnits = [{
        code: conf.adUnitCode,
        sizes: conf.adUnitSizes,
        bids: conf.adUnitBids
    }];

    pbjs.addAdUnits(adUnits);

    pbjs.requestBids({
        timeout: conf.timout,
        bidsBackHandler: function() {
            var iframe = document.getElementById('postbid_if_3');

            var iframeDoc = iframe.contentWindow.document;

            var params = pbjs.getAdserverTargetingForAdUnitCode(conf.adUnitCode);

            // If any bidders return any creatives
            var bid;
            if(params && params['hb_adid']){
                bid = pbjs._bidsReceived.find(bid => bid.adId === params['hb_adid']);
                pbjs.renderAd(iframeDoc, params['hb_adid']);
              } else {
                // If no bidder return any creatives,
                // Passback 3rd party tag in Javascript

                iframe.width = conf.adUnitSizes[0];
                iframe.height = conf.adUnitSizes[1];

                iframeDoc.write(passbackTagHtml);
            }

            var obj = {
              name : 'resizeAd',
              targetId : conf.targetId,
              height : (bid.height) ? bid.height : conf.adUnitSizes[1],
              width : (bid.width) ? bid.width : conf.adUnitSizes[0]
            };
            window.parent.postMessage(JSON.stringify(obj), conf.host);
        }
    });
});
</script>
<iframe id='postbid_if_3' FRAMEBORDER="0" SCROLLING="no" MARGINHEIGHT="0" MARGINWIDTH="0" TOPMARGIN="0" LEFTMARGIN="0" ALLOWTRANSPARENCY="true" WIDTH="0" HEIGHT="0"></iframe>
